<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictiv Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #10a37f;
            --primary-dark: #0d8c6d;
            --send-btn: #10a37f;
            --bg-light: #f8f9fa;
            --text-dark: #333;
            --text-muted: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: white;
            color: var(--text-dark);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--box-shadow);
            z-index: 10;
            border-bottom: 1px solid #e5e7eb;
        }

        .logo-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .logo {
            height: 40px;
            width: auto;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .app-name {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--text-dark);
            margin: 0;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-dark);
        }

        .btn-outline:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .chat-container {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: var(--bg-light);
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            margin: 0.5rem 0;
            border-radius: var(--border-radius);
            line-height: 1.5;
            font-size: 0.95rem;
            animation: fadeIn 0.3s ease-in-out;
            box-shadow: var(--box-shadow);
            position: relative;
            word-wrap: break-word;
        }

        .user {
            background: white;
            color: var(--text-dark);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .bot {
            background: white;
            color: var(--text-dark);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .timestamp {
            font-size: 0.7rem;
            opacity: 0.7;
            position: absolute;
            bottom: -1.25rem;
            right: 0.5rem;
            color: var(--text-muted);
        }

        .sources {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            align-self: flex-start;
            max-width: 85%;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: white;
            border-radius: var(--border-radius);
            margin: 0.5rem 0;
            align-self: flex-start;
            box-shadow: var(--box-shadow);
            font-size: 0.9rem;
            color: var(--text-muted);
            border: 1px solid #e5e7eb;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-section {
            display: flex;
            padding: 1rem;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-right: 3rem;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .input-wrapper input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);
        }

        .input-actions {
            position: absolute;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .input-actions button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            padding: 0.25rem;
        }

        .input-actions button:hover {
            color: var(--send-btn);
        }

        .send-btn {
            background: var(--send-btn);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.25rem;
            margin-left: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ddd;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .empty-state p {
            max-width: 400px;
            margin-bottom: 1.5rem;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .suggestion-chip {
            background: white;
            border: 1px solid #eee;
            border-radius: 1.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .suggestion-chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Web search toggle styles */
        .web-search-toggle {
            display: flex;
            align-items: center;
            margin-left: 1rem;
        }

        .toggle-label {
            margin-left: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-dark);
        }

        /* Switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--send-btn);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .search-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .message {
                max-width: 90%;
            }
            
            .input-section {
                padding: 0.75rem;
            }
            
            .send-btn {
                padding: 0.75rem;
            }

            .logo {
                height: 32px;
            }

            .app-name {
                font-size: 1rem;
            }
            
            .web-search-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="/" class="logo-link">
            <img src="/static/logo.svg" alt="Logo" class="logo">
            <span class="app-name">Predictiv Chatbot</span>
        </a>

        <!-- Add this to your header section -->
<div class="mcp-toggle" onclick="toggleMcpPanel()">
    <i class="fas fa-puzzle-piece"></i>
    <span>MCP Tools</span>
</div>

<!-- Add this modal for MCP tools -->
<div id="mcpModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeMcpModal()">&times;</span>
        <h3>Available MCP Tools</h3>
        <div id="mcpToolsList" class="mcp-tools-list">
            <!-- MCP tools will be populated here -->
        </div>
    </div>
</div>

<!-- Add this CSS -->
<style>
    .mcp-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(16, 163, 127, 0.1);
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        margin-left: 1rem;
    }
    
    .mcp-toggle:hover {
        background: rgba(16, 163, 127, 0.2);
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        width: 80%;
        max-width: 500px;
        box-shadow: var(--box-shadow);
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: black;
    }
    
    .mcp-tools-list {
        margin-top: 1rem;
    }
    
    .mcp-tool {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: var(--border-radius);
        border-left: 4px solid var(--primary);
    }
    
    .mcp-tool h4 {
        margin: 0 0 0.25rem 0;
        color: var(--text-dark);
    }
    
    .mcp-tool p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.9rem;
    }
</style>

<!-- Add this JavaScript -->
<script>
    function toggleMcpPanel() {
        document.getElementById('mcpModal').style.display = 'block';
        loadMcpTools();
    }
    
    function closeMcpModal() {
        document.getElementById('mcpModal').style.display = 'none';
    }
    
    function loadMcpTools() {
        fetch('/mcp/servers')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const toolsList = document.getElementById('mcpToolsList');
                    toolsList.innerHTML = '';
                    
                    for (const [key, tool] of Object.entries(data.servers)) {
                        if (tool.enabled) {
                            const toolElement = document.createElement('div');
                            toolElement.className = 'mcp-tool';
                            toolElement.innerHTML = `
                                <h4>${tool.name}</h4>
                                <p>${tool.description}</p>
                            `;
                            toolsList.appendChild(toolElement);
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading MCP tools:', error);
            });
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('mcpModal');
        if (event.target === modal) {
            closeMcpModal();
        }
    }
</script>



        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="web-search-toggle">
                <label class="switch">
                    <input type="checkbox" id="webSearchToggle" checked>
                    <span class="slider round"></span>
                </label>
                <span class="toggle-label">Web Search</span>
                <span class="search-status" id="searchStatus">ON</span>
            </div>
            <button class="btn btn-outline" onclick="clearChat()">
                <i class="fas fa-trash-alt"></i>
                Clear
            </button>
        </div>
    </header>

    <input type="hidden" id="sessionId" value="{{ session_id }}">

    <div class="chat-container" id="chatBox">
        <div class="empty-state" id="emptyState">
            <i class="fas fa-comments"></i>
            <h3>Start chatting with AI + Web Search</h3>
            <p>Ask anything and get answers with real-time web search</p>
            <div class="suggestions">
                <div class="suggestion-chip" onclick="insertSuggestion('What is the latest news about AI?')">AI News</div>
                <div class="suggestion-chip" onclick="insertSuggestion('Explain quantum computing')">Quantum Computing</div>
                <div class="suggestion-chip" onclick="insertSuggestion('Best programming languages in 2025')">Programming</div>
            </div>
        </div>
    </div>

    <div class="input-section">
        <div class="input-wrapper">
            <input type="text" id="question" placeholder="Ask anything..." 
                   onkeydown="handleKeyPress(event)">
            <div class="input-actions">
                <button onclick="insertSampleQuestion()" title="Sample question">
                    <i class="fas fa-lightbulb"></i>
                </button>
                <button onclick="clearInput()" title="Clear input">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <button class="send-btn" onclick="askQuestionStream()">
            <i class="fas fa-paper-plane"></i>
            <span class="send-text">Send</span>
        </button>
    </div>

    <script>
        // DOM elements
        const chatBox = document.getElementById('chatBox');
        const emptyState = document.getElementById('emptyState');
        const questionInput = document.getElementById('question');
        const searchStatus = document.getElementById('searchStatus');

        // Get current timestamp
        function getTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Toggle web search function
        function toggleWebSearch() {
            const webSearchToggle = document.getElementById('webSearchToggle');
            const isEnabled = webSearchToggle ? webSearchToggle.checked : true;
            
            // Update status display
            if (searchStatus) {
                searchStatus.textContent = isEnabled ? 'ON' : 'OFF';
                searchStatus.style.background = isEnabled ? 'rgba(16, 163, 127, 0.1)' : 'rgba(108, 117, 125, 0.1)';
                searchStatus.style.color = isEnabled ? '#0d8c6d' : '#6c757d';
            }
            
            return isEnabled;
        }

        // Save chat history to localStorage
        function saveChatHistory() {
            const messages = chatBox.querySelectorAll('.message');
            const history = Array.from(messages).map(msg => ({
                text: msg.innerText.replace(getTimestamp(), '').trim(),
                sender: msg.classList.contains('user') ? 'user' : 'bot',
                time: msg.querySelector('.timestamp').textContent
            }));
            localStorage.setItem('chatHistory', JSON.stringify(history));
        }

        // Load chat history from localStorage
        function loadChatHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                const history = JSON.parse(saved);
                if (history.length > 0) {
                    emptyState.style.display = 'none';
                    history.forEach(msg => {
                        addMessage(msg.text, msg.sender, msg.time, false);
                    });
                    scrollToBottom();
                }
            }
        }
        // Clear chat history from backend
function clearChatHistoryFromBackend() {
    const sessionId = document.getElementById('sessionId').value;
    
    fetch('/clear-history', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json' 
        },
        body: JSON.stringify({ 
            session_id: sessionId
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Chat history cleared from backend');
        } else {
            console.error('Error clearing chat history:', data.message);
        }
    })
    .catch(error => {
        console.error('Error clearing chat history:', error);
    });
}

// Clear chat history
function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        chatBox.innerHTML = '';
        localStorage.removeItem('chatHistory');
        emptyState.style.display = 'flex';
        
        // Clear from backend as well
        clearChatHistoryFromBackend();
    }
}

       

        // Add message to chat
        function addMessage(text, sender, customTime = null, scroll = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            
            const timeSpan = document.createElement('div');
            timeSpan.className = 'timestamp';
            timeSpan.textContent = customTime || getTimestamp();
            messageDiv.appendChild(timeSpan);
            
            chatBox.appendChild(messageDiv);
            
            if (scroll) {
                scrollToBottom();
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            const useWebSearch = toggleWebSearch();
            const statusText = useWebSearch ? 'Searching and analyzing' : 'Thinking';
            
            typingDiv.innerHTML = `
                <span>${statusText}</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatBox.appendChild(typingDiv);
            scrollToBottom();
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Scroll chat to bottom
        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Handle Enter key press
        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askQuestionStream();
            }
        }

        // Clear input field
        function clearInput() {
            questionInput.value = '';
            questionInput.focus();
        }

        // Insert suggestion into input
        function insertSuggestion(text) {
            questionInput.value = text;
            questionInput.focus();
        }

        // Insert sample question
        function insertSampleQuestion() {
            const useWebSearch = toggleWebSearch();
            let samples;
            
            if (useWebSearch) {
                samples = [
                    "What's the latest news about AI?",
                    "Explain quantum computing in simple terms",
                    "Best programming languages to learn in 2025",
                    "How does photosynthesis work?",
                    "What are the health benefits of meditation?",
                    "Latest developments in renewable energy"
                ];
            } else {
                samples = [
                    "Explain the theory of relativity",
                    "What are the principles of good UX design?",
                    "How does machine learning work?",
                    "What is the capital of France?",
                    "Tell me about the history of the internet",
                    "What are the benefits of regular exercise?"
                ];
            }
            
            const randomQuestion = samples[Math.floor(Math.random() * samples.length)];
            questionInput.value = randomQuestion;
            questionInput.focus();
        }

        // New function to handle streaming responses
        function askQuestionStream() {
            const question = questionInput.value.trim();
            const sessionId = document.getElementById('sessionId').value;
            const useWebSearch = toggleWebSearch();
            
            if (!question) return;

            // Add user message to chat
            addMessage(question, 'user');
            questionInput.value = '';
            
            // Hide empty state if it's the first message
            if (emptyState.style.display !== 'none') {
                emptyState.style.display = 'none';
            }

            // Create a new message element for the bot's response
            const messageId = 'msg-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.id = messageId;
            
            const timeSpan = document.createElement('div');
            timeSpan.className = 'timestamp';
            timeSpan.textContent = getTimestamp();
            
            messageDiv.appendChild(timeSpan);
            chatBox.appendChild(messageDiv);
            
            // Show searching indicator
            showTypingIndicator();
            
            // Scroll to bottom
            scrollToBottom();
            
            // Create EventSource for streaming
            const eventSource = new EventSource(`/ask-stream?question=${encodeURIComponent(question)}&session_id=${sessionId}&web_search=${useWebSearch}`);
            let fullResponse = '';
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.token) {
                    fullResponse += data.token;
                    document.getElementById(messageId).innerHTML = fullResponse.replace(/\n/g, '<br>') + timeSpan.outerHTML;
                    scrollToBottom();
                } else if (data.error) {
                    document.getElementById(messageId).innerHTML = `Error: ${data.error}` + timeSpan.outerHTML;
                    eventSource.close();
                    removeTypingIndicator();
                } else if (data.complete) {
                    eventSource.close();
                    removeTypingIndicator();
                    
                    // Save to chat history
                    saveChatHistory();
                }
            };
            
            eventSource.onerror = function() {
                eventSource.close();
                removeTypingIndicator();
                // Save to chat history
                saveChatHistory();
            };
        }

        // Initialize the chat
        window.onload = function() {
            loadChatHistory();
            questionInput.focus();
            
            // Initialize web search toggle status
            toggleWebSearch();
            
            // Add event listener to web search toggle
            const webSearchToggle = document.getElementById('webSearchToggle');
            if (webSearchToggle) {
                webSearchToggle.addEventListener('change', toggleWebSearch);
            }
        };
    </script>
</body>
</html>